(()=>{var r={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:null},h={allergy:"medcloud2.nhi.gov.tw/imu/api/imue0040/imue0040s02/get-data",surgery:"medcloud2.nhi.gov.tw/imu/api/imue0020/imue0020s02/get-data",discharge:"medcloud2.nhi.gov.tw/imu/api/imue0070/imue0070s02/get-data",medDays:"medcloud2.nhi.gov.tw/imu/api/imue0120/imue0120s01/pres-med-day",patientSummary:"medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary",chinesemed:"medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data",imaging:"medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data",medication:"medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data",labdata:"medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data"};Object.entries(h).forEach(([t,a])=>{chrome.webRequest.onBeforeRequest.addListener(function(e){return e.method==="GET"&&e.url.includes(a)&&chrome.tabs.sendMessage(e.tabId,{action:"apiCallDetected",url:e.url,type:t}),{cancel:!1}},{urls:[`https://${a}*`]},["requestBody"]),chrome.webRequest.onCompleted.addListener(function(e){e.method==="GET"&&e.url.includes(a)&&chrome.tabs.sendMessage(e.tabId,{action:"apiCallCompleted",url:e.url,statusCode:e.statusCode,type:t})},{urls:[`https://${a}*`]},["responseHeaders"])});var c={medication:"medicationData",labdata:"labData",chinesemed:"chinesemedData",imaging:"imagingData",allergy:"allergyData",surgery:"surgeryData",discharge:"dischargeData",medDays:"medDaysData",patientSummary:"patientSummaryData"},D=new Map([["openPopup",(t,a,e)=>{chrome.action.openPopup(),e({status:"received"})}],["userSessionChanged",(t,a,e)=>{Object.keys(r).forEach(s=>{r[s]=null}),r.currentUserSession=t.userSession,chrome.storage.local.remove(Object.values(c),function(){chrome.action.setBadgeText({text:""})}),e({status:"session_reset"})}],["clearSessionData",(t,a,e)=>{Object.keys(r).forEach(s=>{r[s]=null}),e({status:"cleared"})}],["getSessionData",(t,a,e)=>{e({status:"success",data:r})}],["getDataStatus",(t,a,e)=>(chrome.storage.local.get(Object.values(c),s=>{let n={},d=(i,l)=>{let u=s[l],m=u?.rObject||u?.robject;m&&Array.isArray(m)?n[i]={status:"fetched",count:m.length}:n[i]={status:"none",count:0}},g={medication:"medication",labdata:"labData",chinesemed:"chineseMed",imaging:"imaging",allergy:"allergy",surgery:"surgery",discharge:"discharge",medDays:"medDays",patientSummary:"patientSummary"};Object.entries(c).forEach(([i,l])=>{let u=g[i]||i;d(u,l)}),e({dataStatus:n})}),!0)],["saveMedicationData",o("medication")],["saveLabData",o("labdata")],["saveChineseMedData",o("chinesemed")],["saveImagingData",o("imaging")],["saveAllergyData",o("allergy")],["saveSurgeryData",o("surgery")],["saveDischargeData",o("discharge")],["saveMedDaysData",o("medDays")],["savePatientSummaryData",o("patientSummary")],["saveToken",(t,a,e)=>{r.token=t.token,r.currentUserSession=t.userSession||r.currentUserSession,e({status:"token_saved"})}]]);function o(t){return function(a,e,s){let n=c[t];if(!n){s({status:"error",error:`Invalid data type: ${t}`});return}r[n]=a.data,r.currentUserSession=a.userSession||r.currentUserSession;let d={[n]:a.data,currentUserSession:a.userSession||r.currentUserSession};chrome.storage.local.set(d,function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),a.data&&a.data.rObject&&Array.isArray(a.data.rObject)?s({status:"saved",recordCount:a.data.rObject.length}):s({status:"saved",recordCount:0,error:"Invalid data format"})})}}chrome.runtime.onMessage.addListener((t,a,e)=>{t.userSession&&t.userSession!==r.currentUserSession&&(Object.keys(r).forEach(n=>{r[n]=null}),r.currentUserSession=t.userSession);let s=D.get(t.action);return s?(s(t,a,e),!0):(e({status:"received"}),!0)});chrome.tabs.onUpdated.addListener((t,a,e)=>{a.url&&(a.url.includes("medcloud2.nhi.gov.tw/imu/login")||a.url.includes("medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0001"))&&(console.log("Detected navigation to login page, clearing session data"),Object.keys(r).forEach(s=>{r[s]=null}),chrome.storage.local.remove(["medicationData","labData","currentUserSession"],function(){console.log("Storage data cleared due to logout"),chrome.action.setBadgeText({text:""})}))});})();
